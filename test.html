<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spider Web Gothic Experience</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital@0;1&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Lora', serif;
      background: linear-gradient(135deg, #2c003e, #4d5566, #1a1f1f);
      overflow-x: hidden;
      color: #ddd;
      position: relative;
    }
    /* Bubbles Background */
    .bubble {
      position: fixed;
      bottom: -100px;
      width: 100px;
      height: 100px;
      background: rgba(147, 112, 219, 0.1);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
      z-index: 0;
    }
    .bubble:nth-child(1) { left: 10%; animation-delay: 0s; }
    .bubble:nth-child(2) { left: 20%; animation-delay: 2s; width: 80px; height: 80px; }
    .bubble:nth-child(3) { left: 70%; animation-delay: 4s; }
    .bubble:nth-child(4) { left: 80%; animation-delay: 1s; width: 60px; height: 60px; }
    .bubble:nth-child(5) { left: 90%; animation-delay: 3s; }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }
    /* Sidebar Navigation */
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 150px;
      height: 100%;
      background: rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      padding: 20px 10px;
      z-index: 10;
      transition: background 0.3s;
    }
    .roomLink {
      margin: 15px 0;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
      font-family: 'Cinzel', serif;
      font-weight: bold;
      color: #ccc;
      transition: all 0.3s;
    }
    .roomLink:hover, .roomLink.active {
      background: rgba(147, 112, 219, 0.5);
      color: #fff;
      transform: translateX(5px);
    }
    /* Content Rooms */
    #content {
      margin-left: 170px;
      padding: 20px;
      max-width: 800px;
    }
    .room {
      min-height: 50vh;
      padding: 40px 0;
      opacity: 0;
      transform: translateY(50px);
      transition: all 0.8s ease;
      font-family: 'Lora', serif;
    }
    .room.active {
      opacity: 1;
      transform: translateY(0);
    }
    .room.rise { transform: translateY(-20px); } /* For upper rooms */
    .room.fall { transform: translateY(20px); } /* For lower rooms */
    h2 {
      font-family: 'Cinzel', serif;
      color: #9370db;
      font-size: 2.5em;
      text-align: center;
      margin-bottom: 20px;
    }
    /* Spider Container */
    #spiderContainer {
      position: fixed;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%);
      z-index: 20;
      transition: top 1s ease 4s, left 1s ease 4s, transform 1s ease 4s;
    }
    #spider {
      font-size: 50px;
      cursor: pointer;
      display: inline-block;
      animation: walk 2s steps(4) infinite;
      transform-origin: bottom left;
      transition: box-shadow 0.3s, filter 0.3s;
      opacity: 0; /* Start hidden, JS will show it */
    }
    #spider.activated {
      box-shadow: 0 0 20px #9370db;
      filter: brightness(1.2);
    }
    #spider.bonus {
      animation: bonusPulse 1s ease-in-out 3;
      box-shadow: 0 0 30px #9370db, inset 0 0 20px #9370db;
    }
    @keyframes walk {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }
    @keyframes wobble {
      0%, 100% { transform: rotate(0); }
      25% { transform: rotate(3deg); }
      75% { transform: rotate(-3deg); }
    }
    #spider.wobble { animation: wobble 0.5s infinite; }
    @keyframes bonusPulse {
      0%, 100% { filter: brightness(1.2); }
      50% { filter: brightness(1.5); }
    }
    #greeting {
      position: absolute;
      bottom: -40px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      padding: 5px 10px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.5s;
      font-family: 'Cinzel', serif;
      color: #9370db;
    }
    #greeting.show { opacity: 1; }
    /* Scrolling Elements */
    #scrollTitle, #scrollLyrics {
      position: fixed;
      width: 100%;
      height: 30px;
      background: rgba(0,0,0,0.4);
      color: #fff;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      z-index: 5;
    }
    #scrollTitle { top: 0; }
    #scrollLyrics { bottom: 0; }
    #scrollText, #lyricsText {
      display: inline-block;
      padding-left: 100%;
      animation: scroll-left 15s linear infinite;
      font-family: 'Cinzel', serif;
    }
    @keyframes scroll-left {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    /* Overlays */
    #backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 15;
      opacity: 0;
      transition: opacity 0.3s;
    }
    #backdrop.show { opacity: 1; }
    /* Playlist Drawer */
    #playlistDrawer {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100%;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 20px;
      z-index: 20;
      transition: right 0.3s;
      overflow-y: auto;
    }
    #playlistDrawer.open { right: 0; }
    #closeDrawer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .track {
      display: flex;
      align-items: center;
      margin: 15px 0;
      cursor: pointer;
      padding: 10px;
      border-radius: 4px;
      transition: background 0.3s;
    }
    .track:hover, .track.active {
      background: rgba(147, 112, 219, 0.3);
    }
    .track img { width: 50px; height: 50px; border-radius: 4px; margin-right: 10px; }
    .track-info h4 { margin: 0; font-family: 'Cinzel', serif; }
    #playlistControls { margin-top: 20px; text-align: center; }
    #playlistControls button {
      background: rgba(147, 112, 219, 0.5);
      border: none;
      color: #fff;
      padding: 10px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    #volumeSlider { width: 100px; }
    /* Synced Lyrics Overlay */
    #lyricsOverlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 600px;
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 20px;
      border-radius: 8px;
      z-index: 25;
      opacity: 0;
      transition: opacity 0.3s;
      text-align: center;
    }
    #lyricsOverlay.show { opacity: 1; }
    #closeLyrics {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    #lyricsTitle { font-family: 'Cinzel', serif; color: #9370db; margin-bottom: 20px; }
    .lyric-word {
      margin: 0 2px;
      padding: 2px 4px;
      transition: all 0.3s;
      font-family: 'Lora', italic;
    }
    .lyric-word.active {
      color: #9370db;
      transform: scale(1.2);
      text-shadow: 0 0 10px #9370db;
    }
    /* Web Trail */
    #webTrail {
      position: fixed;
      width: 2px;
      height: 0;
      background: linear-gradient(to bottom, transparent, #9370db);
      z-index: 18;
      opacity: 0;
      transition: all 0.5s ease;
      pointer-events: none;
      box-shadow: 0 0 5px rgba(147, 112, 219, 0.5);
      border-radius: 1px;
    }
    #webTrail.show { opacity: 0.8; }
    #webTrail.pointing {
      height: 150px;
      transform: rotate(-45deg);
      border: 1px dashed rgba(147, 112, 219, 0.3);
    }
    #webTrail::before {
      content: '';
      position: absolute;
      top: 20%;
      left: -5px;
      width: 4px;
      height: 4px;
      background: #9370db;
      border-radius: 50%;
      opacity: 0.6;
      animation: trailPulse 1s ease-in-out infinite alternate;
    }
    @keyframes trailPulse {
      0% { opacity: 0.6; transform: scale(1); }
      100% { opacity: 1; transform: scale(1.2); }
    }
    /* Intro Web */
    #introWeb {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 30;
      opacity: 1;
      transition: opacity 1s ease 3s;
      background: rgba(147, 112, 219, 0.1);
      pointer-events: none;
    }
    #introWeb.revealed { opacity: 0; }
    #webSVG {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      height: 400px;
      opacity: 0.7;
      filter: drop-shadow(0 0 10px rgba(147, 112, 219, 0.5));
      animation: webWeave 4s ease-out forwards;
    }
    @keyframes webWeave {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      20% { opacity: 0.7; transform: translate(-50%, -50%) scale(0.8); }
      100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.2); }
    }
    #siteContainer {
      opacity: 0;
      transition: opacity 1s ease 4s;
      position: relative;
      z-index: 1;
    }
    #siteContainer.revealed { opacity: 1; }
    /* Game Riddle */
    #gameRiddle {
      text-align: center;
      margin: 20px 0;
      font-family: 'Cinzel', serif;
      color: #9370db;
    }
    #riddleText {
      font-size: 1.1em;
      margin-bottom: 15px;
      font-style: italic;
    }
    #riddleInput {
      padding: 10px;
      background: rgba(147, 112, 219, 0.2);
      border: 1px solid #9370db;
      color: #ddd;
      border-radius: 4px;
      width: 200px;
      font-family: 'Lora', serif;
    }
    #riddleInput:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(147, 112, 219, 0.5);
    }
    #riddleBtn {
      padding: 10px 20px;
      background: rgba(147, 112, 219, 0.5);
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
      font-family: 'Cinzel', serif;
      transition: background 0.3s;
    }
    #riddleBtn:hover { background: rgba(147, 112, 219, 0.7); }
    #riddleBtn:disabled {
      background: rgba(128, 128, 128, 0.5);
      cursor: not-allowed;
    }
   }
    #riddleSuccess, #riddleError {
      margin-top: 10px;
      opacity: 0;
      transition: opacity 0.5s ease;
      display: none;
    }
    #riddleSuccess.show, #riddleError.show {
      display: block;
      opacity: 1;
    }
    #riddleSuccess { color: #9370db; font-weight: bold; }
    #riddleError { color: #ff6b6b; }
    /* Mobile */
    @media (max-width: 768px) {
      #sidebar { width: 100%; height: auto; flex-direction: row; justify-content: center; }
      #content { margin-left: 0; }
      #spider { font-size: 40px; }
    }
  </style>
</head>
<body>
  <!-- Bubbles -->
  <div class="bubble"></div>
  <div class="bubble"></div>
  <div class="bubble"></div>
  <div class="bubble"></div>
  <div class="bubble"></div>

  <!-- Scrolling Elements -->
  <div id="scrollTitle"><div id="scrollText"></div></div>
  <div id="scrollLyrics"><div id="lyricsText"></div></div>

  <!-- Intro Web -->
  <div id="introWeb">
    <svg id="webSVG" width="100%" height="100%" viewBox="0 0 100 100">
      <!-- Central node (spider position) -->
      <circle cx="50" cy="50" r="2" fill="#9370db" opacity="0">
        <animate attributeName="opacity" from="0" to="1" dur="1s" begin="0.5s" fill="freeze"/>
        <animate attributeName="r" from="0" to="2" dur="0.5s" begin="0.5s" fill="freeze"/>
      </circle>
      <!-- Radial strands (8 lines expanding outward, like spider legs/web) -->
      <line x1="50" y1="50" x2="50" y2="0" stroke="#9370db" stroke-width="1" opacity="0" stroke-dasharray="5,5">
        <animate attributeName="opacity" from="0" to="0.6" dur="2s" begin="1s" fill="freeze"/>
        <animate attributeName="y2" from="50" to="0" dur="2s" begin="1s" fill="freeze"/>
      </line>
      <line x1="50" y1="50" x2="100" y2="50" stroke="#9370db" stroke-width="1" opacity="0" stroke-dasharray="5,5">
        <animate attributeName="opacity" from="0" to="0.6" dur="2s" begin="1.2s" fill="freeze"/>
        <animate attributeName="x2" from="50" to="100" dur="2s" begin="1.2s" fill="freeze"/>
      </line>
      <line x1="50" y1="50" x2="0" y2="50" stroke="#9370db" stroke-width="1" opacity="0" stroke-dasharray="5,5">
        <animate attributeName="opacity" from="0" to="0.6" dur="2s" begin="1.4s" fill="freeze"/>
        <animate attributeName="x2" from="50" to="0" dur="2s" begin="1.4s" fill="freeze"/>
      </line>
      <line x1="50" y1="50" x2="50" y2="100" stroke="#9370db" stroke-width="1" opacity="0" stroke-dasharray="5,5">
        <animate attributeName="opacity" from="0" to="0.6" dur="2s" begin="1.6s" fill="freeze"/>
        <animate attributeName="y2" from="50" to="100" dur="2s" begin="1.6s" fill="freeze"/>
      </line>
      <!-- Diagonal strands for fuller web (4 more for epic spread) -->
      <line x1="50" y1="50" x2="100" y2="0" stroke="#9370db" stroke-width="1" opacity="0" stroke-dasharray="5,5">
        <animate attributeName="opacity" from="0" to="0.4" dur="2s" begin="1.8s" fill="freeze"/>
        <animate attributeName="x2" from="50" to="100" dur="2s" begin="1.8s" fill="freeze"/>
        <animate attributeName="y2" from="50" to="0" dur="2s" begin="1.8s" fill="freeze"/>
      </line>
      <line x1="50" y1="50" x2="0" y2="0" stroke="#9370db" stroke-width="1" opacity="0" stroke-dasharray="5,5">
        <animate attributeName="opacity" from="0" to="0.4" dur="2s" begin="2s" fill="freeze"/>
        <animate attributeName="x2" from="50" to="0" dur="2s" begin="2s" fill="freeze"/>
        <animate attributeName="y2" from="50" to="0" dur="2s" begin="2s" fill="freeze"/>
      </line>
      <line x1="50" y1="50" x2="100" y2="100" stroke="#9370db" stroke-width="1" opacity="0" stroke-dasharray="5,5">
        <animate attributeName="opacity" from="0" to="0.4" dur="2s" begin="2.2s" fill="freeze"/>
        <animate attributeName="x2" from="50" to="100" dur="2s" begin="2.2s" fill="freeze"/>
        <animate attributeName="y2" from="50" to="100" dur="2s" begin="2.2s" fill="freeze"/>
      </line>
      <line x1="50" y1="50" x2="0" y2="100" stroke="#9370db" stroke-width="1" opacity="0" stroke-dasharray="5,5">
        <animate attributeName="opacity" from="0" to="0.4" dur="2s" begin="2.4s" fill="freeze"/>
        <animate attributeName="x2" from="50" to="0" dur="2s" begin="2.4s" fill="freeze"/>
        <animate attributeName="y2" from="50" to="100" dur="2s" begin="2.4s" fill="freeze"/>
      </line>
      <!-- Outer ring (expanding circle) -->
      <circle cx="50" cy="50" r="0" fill="none" stroke="#9370db" stroke-width="1" opacity="0" stroke-dasharray="10,10">
        <animate attributeName="opacity" from="0" to="0.3" dur="3s" begin="1s" fill="freeze"/>
        <animate attributeName="r" from="0" to="45" dur="3s" begin="1s" fill="freeze"/>
      </circle>
    </svg>
    <!-- Simple CSS fallback web (concentric around spider) -->
    <div id="webFallback"></div>
  </div>

  <!-- Site Container (hidden initially, reveals after web) -->
  <div id="siteContainer">
    <!-- Sidebar for navigation -->
    <div id="sidebar">
      <div class="roomLink active" data-room="top">Home</div>
      <div class="roomLink" data-room="instructions">Instructions</div>
      <div class="roomLink" data-room="game">Game</div>
      <div class="roomLink" data-room="social">Social</div>
    </div>

    <!-- Spider container (starts centered for intro) -->
    <div id="spiderContainer">
      <div id="web"></div> <!-- Small web around spider -->
      <div id="greeting">Greetings, wanderer! Click to hear the tunes.</div>
      <div id="spider" title="Click me">🕷️</div>
    </div>

    <!-- Content sections (rooms) -->
    <div id="content">
      <div id="top" class="room active">
        <h2>Welcome</h2>
        <p>Use the sidebar to navigate rooms. Click the spider to meet your guide and listen to music!</p>
      </div>
      <div id="instructions" class="room">
        <h2>Instructions</h2>
        <p>This is the instructions room. Anchored here—explore like entering a new chamber. Click the spider to meet here and listen to sample music.</p>
      </div>
      <div id="game" class="room">
        <h2>Game</h2>
        <p>This is the game room. Anchored at the heart—feel the adventure. Click the spider to join and listen.</p>
        <div id="gameRiddle">
          <div id="riddleText">Riddle: I weave the night with silken thread, eight legs I tread where shadows spread. What am I?</div>
          <input type="text" id="riddleInput" placeholder="Your answer..." autocomplete="off">
          <button id="riddleBtn">Weave the Web</button>
          <div id="riddleSuccess">🕷️ The web is woven! Bonus track unlocked.</div>
          <div id="riddleError">Not quite... Try again, wanderer.</div>
        </div>
      </div>
      <div id="social" class="room fall">
        <h2>Social</h2>
        <p>This is the social room. Anchored below—connect in the web. Click the spider to connect and listen.</p>
      </div>
    </div>

    <!-- Backdrop for overlays -->
    <div id="backdrop"></div>

    <!-- Web Trail Element -->
    <div id="webTrail"></div>

    <!-- Playlist Drawer -->
    <div id="playlistDrawer">
      <button id="closeDrawer">&times;</button>
      <h3 style="font-family: 'Cinzel', serif; color: #9370db;">Playlist</h3>
      <div id="playlistTracks"></div>
      <div id="playlistControls">
        <button id="prevTrack">&lt;</button>
        <button id="playPause">⏸️</button>
        <button id="nextTrack">&gt;</button>
        <br><label>Volume: <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5"></label>
      </div>
    </div>

    <!-- Synced Lyrics Overlay -->
    <div id="lyricsOverlay">
      <button id="closeLyrics">&times;</button>
      <h3 id="lyricsTitle"></h3>
      <div id="syncedLyrics"></div>
    </div>

    <!-- Audio Element -->
    <audio id="audio" preload="auto">
      <source src="" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
  </div>

  <script>
    // Variables
    const spider = document.getElementById('spider');
    const spiderContainer = document.getElementById('spiderContainer');
    const greeting = document.getElementById('greeting');
    const audio = document.getElementById('audio');
    const playlistDrawer = document.getElementById('playlistDrawer');
    const closeDrawer = document.getElementById('closeDrawer');
    const backdrop = document.getElementById('backdrop');
    const webTrail = document.getElementById('webTrail');
    const lyricsOverlay = document.getElementById('lyricsOverlay');
    const closeLyrics = document.getElementById('closeLyrics');
    const syncedLyrics = document.getElementById('syncedLyrics');
    const lyricsTitle = document.getElementById('lyricsTitle');
    const scrollTitle = document.getElementById('scrollTitle');
    const scrollLyrics = document.getElementById('scrollLyrics');
    const scrollText = document.getElementById('scrollText');
    const lyricsText = document.getElementById('lyricsText');
    const playlistTracks = document.getElementById('playlistTracks');
    const prevTrack = document.getElementById('prevTrack');
    const nextTrack = document.getElementById('nextTrack');
    const playPause = document.getElementById('playPause');
    const volumeSlider = document.getElementById('volumeSlider');
    const riddleInput = document.getElementById('riddleInput');
    const riddleBtn = document.getElementById('riddleBtn');
    const riddleSuccess = document.getElementById('riddleSuccess');
    const riddleError = document.getElementById('riddleError');

    let currentTrack = 0;
    let isDrawerOpen = false;
    let isLyricsOpen = false;
    let isDropped = false;
    let hasGreeted = false;
    let bonusUnlocked = false;
    let currentHighlightInterval = null;
    const rooms = {
      top: document.getElementById('top'),
      instructions: document.getElementById('instructions'),
      game: document.getElementById('game'),
      social: document.getElementById('social')
    };

    // Playlist with tracks, lyrics, and timings (synced words in ms arrays)
    const playlist = [
      {
        title: 'Midnight Sonata',
        artist: 'Shadow Weaver',
        src: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', // Placeholder; replace with real
        artwork: 'data:image/svg+xml;base64,...', // Base64 placeholder or URL
        lyrics: 'In the midnight hour, shadows dance so free...',
        syncedLyrics: ['In', 'the', 'midnight', 'hour,', 'shadows', 'dance', 'so', 'free...'], // Word array
        timings: [0, 500, 1000, 1500, 2000, 2500, 3000, 3500] // ms for each word
      },
      {
        title: 'Whispers in the Web',
        artist: 'Silk Phantom',
        src: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
        artwork: 'data:image/svg+xml;base64,...',
        lyrics: 'Threads of fate entwine, in the velvet night...',
        syncedLyrics: ['Threads', 'of', 'fate', 'entwine,', 'in', 'the', 'velvet', 'night...'],
        timings: [0, 600, 1200, 1800, 2400, 3000, 3600, 4200]
      },
      {
        title: 'Echoes of Paris',
        artist: 'Gothic Muse',
        src: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
        artwork: 'data:image/svg+xml;base64,...',
        lyrics: 'Under Eiffel lights, secrets softly call...',
        syncedLyrics: ['Under', 'Eiffel', 'lights,', 'secrets', 'softly', 'call...'],
        timings: [0, 700, 1400, 2100, 2800, 3500]
      }
    ];

    // Bonus Track (unlocks via riddle)
    const bonusTrack = {
      title: 'Web of Secrets',
      artist: 'Arachne\'s Lullaby',
      src: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', // Bonus placeholder
      artwork: 'data:image/svg+xml;base64,...',
      lyrics: 'Hidden in the strands, truths await the brave...',
      syncedLyrics: ['Hidden', 'in', 'the', 'strands,', 'truths', 'await', 'the', 'brave...'],
      timings: [0, 800, 1600, 2400, 3200, 4000, 4800, 5600]
    };

    // Render Playlist in Drawer
    function renderPlaylist() {
      playlistTracks.innerHTML = '';
      playlist.forEach((track, index) => {
        const trackEl = document.createElement('div');
        trackEl.className = 'track' + (index === currentTrack ? ' active' : '');
        trackEl.innerHTML = `
          <img src="${track.artwork}" alt="${track.title}">
          <div class="track-info">
            <h4>${track.title}</h4>
            <p>${track.artist}</p>
          </div>
        `;
        trackEl.onclick = () => selectTrack(index);
        playlistTracks.appendChild(trackEl);
      });
      updateActiveTrack();
    }

    function selectTrack(index) {
      currentTrack = index;
      audio.src = playlist[index].src;
      audio.play();
      renderPlaylist();
      showSyncedLyrics(playlist[index]);
      updateScrollingElements();
    }

    function updateActiveTrack() {
      document.querySelectorAll('.track').forEach((t, i) => {
        t.classList.toggle('active', i === currentTrack);
      });
    }

    // Play/Pause Sample
    function playSample() {
      if (audio.paused) {
        audio.play();
        playPause.textContent = '⏸️';
        if (!isLyricsOpen) {
          showSyncedLyrics(playlist[currentTrack]);
        }
      } else {
        audio.pause();
        playPause.textContent = '▶️';
      }
    }

    // Volume Control
    volumeSlider.oninput = (e) => {
      audio.volume = e.target.value;
    };

    // Navigation Controls
    prevTrack.onclick = () => {
      currentTrack = (currentTrack - 1 + playlist.length) % playlist.length;
      selectTrack(currentTrack);
    };
    nextTrack.onclick = () => {
      currentTrack = (currentTrack + 1) % playlist.length;
      selectTrack(currentTrack);
    };
    playPause.onclick = playSample;

    // Update Scrolling Elements (Fallback Lyrics/Title)
    function updateScrollingElements() {
      const track = playlist[currentTrack];
      scrollText.textContent = track.title + ' - ' + track.artist;
      lyricsText.textContent = track.lyrics;
    }

    // Synced Lyrics Overlay
    function showSyncedLyrics(track) {
      lyricsTitle.textContent = track.title + ' - ' + track.artist;
      syncedLyrics.innerHTML = track.syncedLyrics.map(word => `<span class="lyric-word">${word}</span>`).join(' ');
      lyricsOverlay.classList.add('show');
      isLyricsOpen = true;
      backdrop.classList.add('show');

      // Highlight words based on timings
      let wordIndex = 0;
      currentHighlightInterval = setInterval(() => {
        if (wordIndex < track.syncedLyrics.length) {
          // Remove previous active class
          document.querySelectorAll('.lyric-word').forEach(w => w.classList.remove('active'));
          // Add active to current word
          document.querySelectorAll('.lyric-word')[wordIndex].classList.add('active');
          wordIndex++;
        } else {
          clearInterval(currentHighlightInterval);
          // Loop back or pause at end
          wordIndex = 0;
        }
      }, 500); // Update every 500ms (adjust for sync)
    }

    // Close Lyrics Overlay
    closeLyrics.onclick = () => {
      lyricsOverlay.classList.remove('show');
      backdrop.classList.remove('show');
      isLyricsOpen = false;
      if (currentHighlightInterval) {
        clearInterval(currentHighlightInterval);
        currentHighlightInterval = null;
      }
    };

    // Open/Close Playlist Drawer
    function openDrawer() {
      playlistDrawer.classList.add('open');
      isDrawerOpen = true;
      backdrop.classList.add('show');
      renderPlaylist();
    }

    closeDrawer.onclick = () => {
      playlistDrawer.classList.remove('open');
      isDrawerOpen = false;
      backdrop.classList.remove('show');
    };

    // Web Trail Pointing Animation
    function pointToSidebar() {
      const spiderRect = spiderContainer.getBoundingClientRect();
      const sidebarRect = document.getElementById('sidebar').getBoundingClientRect();
      const distanceToSidebar = spiderRect.left - sidebarRect.right;
      
      webTrail.style.left = (spiderRect.left - 25) + 'px';
      webTrail.style.top = (spiderRect.top + 25) + 'px';
      webTrail.style.height = Math.max(100, Math.abs(distanceToSidebar * 0.5)) + 'px';
      
      webTrail.classList.add('show', 'pointing');
      webTrail.style.transform = 'rotate(-45deg) scale(1.2)';
      setTimeout(() => {
        webTrail.style.transform = 'rotate(-45deg) scale(1)';
      }, 200);

      setTimeout(() => {
        webTrail.classList.remove('show', 'pointing');
        webTrail.style.height = '0';
        webTrail.style.transform = 'rotate(0deg) scale(1)';
      }, 2000);
    }

    // Spider Animations
    function animateSpider() {
      spider.classList.add('activated');
      spider.style.animation = 'wobble 0.5s ease-in-out';
      setTimeout(() => {
        spider.style.animation = 'walk 2s steps(4) infinite';
      }, 500);

      // Drop to center
      spiderContainer.style.top = '50%';
      spiderContainer.style.left = '50%';
      spiderContainer.style.transform = 'translate(-50%, -50%)';

      // Point trail, open drawer, play
      pointToSidebar();
      openDrawer();
      playSample();
      if (!isLyricsOpen) {
        showSyncedLyrics(playlist[currentTrack]);
      }
    }

    // Spider Follow to Room
    function followToRoom(roomId) {
      const roomEl = rooms[roomId];
      if (!roomEl) return;
      const roomRect = roomEl.getBoundingClientRect();
      let targetTop = roomRect.top + window.scrollY - 100; // Offset above room
      let targetLeft = roomRect.left + 50; // Near content

      // Adjust for specific rooms
      if (roomId === 'game') {
        targetTop -= 50; // Higher for Game room
        spiderContainer.classList.add('heroic'); // Optional glow
      } else if (roomId === 'social') {
        targetTop += 50; // Lower for Social
      }

      spiderContainer.style.top = targetTop + 'px';
      spiderContainer.style.left = targetLeft + 'px';
      spiderContainer.style.transform = 'none';
    }

    // Room Navigation
    document.querySelectorAll('.roomLink').forEach(link => {
      link.onclick = () => {
        const roomId = link.dataset.room;
        // Update active
        document.querySelectorAll('.roomLink').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        // Show room
        document.querySelectorAll('.room').forEach(r => r.classList.remove('active', 'rise', 'fall'));
        rooms[roomId].classList.add('active');
        if (roomId === 'game') {
          rooms[roomId].classList.add('rise');
        } else if (roomId === 'social') {
          rooms[roomId].classList.add('fall');
        }
        // Scroll to room
        rooms[roomId].scrollIntoView({ behavior: 'smooth' });
        // Spider follows
        followToRoom(roomId);
        // Point trail if spider clicked recently
        setTimeout(() => pointToSidebar(), 500);
      };
    });

    // Spider Click Handler
    spider.addEventListener('click', () => {
      if (document.getElementById('siteContainer').classList.contains('revealed')) {
        if (!isDropped) {
          animateSpider();
          isDropped = true;
        } else {
          // Toggle play/pause
          playSample();
          // Wobble on pause
          if (audio.paused) {
            spider.classList.add('wobble');
            setTimeout(() => spider.classList.remove('wobble'), 1000);
          }
          // Point trail on each click
          pointToSidebar();
          // Toggle drawer if open
          if (isDrawerOpen) {
            closeDrawer.click();
          } else {
            openDrawer();
          }
        }
      } else {
        // During intro: Just activate glow
        spider.classList.add('activated');
      }
    });

    // Game Room Riddle
    const correctAnswer = 'spider';
    riddleBtn.onclick = () => {
      const answer = riddleInput.value.trim().toLowerCase();
      if (answer === correctAnswer) {
        if (!bonusUnlocked) {
          playlist.push(bonusTrack);
          bonusUnlocked = true;
          riddleSuccess.classList.add('show');
          riddleError.classList.remove('show');
          riddleInput.disabled = true;
          riddleBtn.disabled = true;
          riddleBtn.textContent = 'Unlocked!';

          // Bonus effects
          spider.classList.add('bonus');
          setTimeout(() => spider.classList.remove('bonus'), 3000);
          pointToSidebar(); // Celebrate with trail

          // Auto-play bonus
          currentTrack = playlist.length - 1;
          playSample();
          showSyncedLyrics(playlist[currentTrack]);
          openDrawer();
          renderPlaylist();
          updateActiveTrack();
        }
      } else {
        riddleError.classList.add('show');
        riddleSuccess.classList.remove('show');
        setTimeout(() => riddleError.classList.remove('show'), 3000);
      }
      riddleInput.value = '';
    };

    riddleInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') riddleBtn.click();
    });

    // Auto-next Track on End
    audio.addEventListener('ended', () => {
      nextTrack.click();
    });

    // Intro Sequence on Load
    window.addEventListener('load', () => {
      // Show spider subtly
      spider.style.opacity = '1';
      spider.style.animation = 'walk 2s steps(4) infinite';

      const introWeb = document.getElementById('introWeb');
      const siteContainer = document.getElementById('siteContainer');
      const webSVG = document.getElementById('webSVG');

      // Start web (SVG animates via CSS)
      setTimeout(() => {
        webSVG.style.opacity = '0.7';
      }, 500);

      // Reveal after 4s
      setTimeout(() => {
        introWeb.classList.add('revealed');
        siteContainer.classList.add('revealed');
        
        // Move spider to start position
        spiderContainer.style.top = '80px';
        spiderContainer.style.left = '50px';
        spiderContainer.style.transform = 'none';
        
        // Init features
        renderPlaylist();
        followToRoom('top');
        if (!hasGreeted) {
          greeting.classList.add('show');
          setTimeout(() => greeting.classList.remove('show'), 3000);
          hasGreeted = true;
        }
        
        // Reset for drop
        isDropped = false;
        spider.style.animation = '';
      }, 4000);

      // Initial scrolling elements
      updateScrollingElements();
    });

    // Backdrop Click to Close Overlays
    backdrop.addEventListener('click', () => {
      if (isDrawerOpen) closeDrawer.click();
      if (isLyricsOpen) closeLyrics.click();
    });

    // Fallback Web Around Spider (CSS-animated)
    const web = document.getElementById('web');
    web.style.cssText = `
      position: absolute;
      top: -20px;
      left: -20px;
      width: 90px;
      height: 90px;
      border: 1px dashed rgba(147, 112, 219, 0.3);
      border-radius: 50%;
      opacity: 0;
      animation: webSpin 3s ease-in-out infinite;
    `;
    const style = document.createElement('style');
    style.textContent = `
      @keyframes webSpin {
        0%, 100% { transform: rotate(0deg) scale(1); opacity: 0.3; }
        50% { transform: rotate(180deg) scale(1.1); opacity: 0.5; }
      }
    `;
    document.head.appendChild(style);

    // Initial Setup
    audio.volume = 0.5;
  </script>
</body>
</html>
